<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button>
        <ion-icon name="menu-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>

    <!-- Logo GYM Pro + Titre Gestion des utilisateurs -->
    <ion-title class="gym-title">
      <div class="title-content">
        <div class="logo-section">
          <ion-icon name="barbell" class="title-icon"></ion-icon>
          <span class="gym-name">GYM Pro</span>
        </div>
        <span class="page-title">Gestion des utilisateurs</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <!-- Bouton Ajouter Utilisateur -->
      <ion-button (click)="navigateToAddUser()" fill="clear" class="add-user-button">
        <ion-icon name="person-add-outline" slot="icon-only"></ion-icon> <!-- CORRIGÉ -->
      </ion-button>
      
      <ion-button>
        <ion-icon name="notifications" slot="icon-only" color="warning"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Barre de recherche et filtres -->
  <ion-toolbar color="dark">
    <ion-searchbar
      placeholder="Rechercher un utilisateur..."
      [(ngModel)]="searchTerm"
      debounce="500"
      animated
      class="custom-searchbar"
      color="light"
    ></ion-searchbar>

    <ion-grid class="filters-grid">
      <ion-row>
        <ion-col size="12" size-sm="6">
          <ion-item class="filter-item" color="dark">
            <ion-select 
              [(ngModel)]="filterRole" 
              interface="action-sheet"
              placeholder="Filtrer par rôle"
              class="role-select"
              color="light"
            >
              <ion-select-option value="ALL">Tous les rôles</ion-select-option>
              <ion-select-option value="ADMIN">Administrateurs</ion-select-option>
              <ion-select-option value="CLIENT">Clients</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
        <ion-col size="12" size-sm="6">
          <ion-chip color="warning" class="results-chip">
            {{ filteredUsers.length }} utilisateur(s) trouvé(s)
          </ion-chip>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" color="light">
  
  <!-- Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Skeleton loading -->
  <div *ngIf="isLoading()" class="skeleton-container">
    <ion-card *ngFor="let item of [1,2,3,4,5]" class="user-card">
      <ion-card-header>
        <ion-grid>
          <ion-row class="ion-align-items-center">
            <ion-col size="auto">
              <ion-skeleton-text animated style="width: 50px; height: 50px; border-radius: 50%;"></ion-skeleton-text>
            </ion-col>
            <ion-col>
              <ion-skeleton-text animated style="width: 60%; height: 20px;"></ion-skeleton-text>
              <ion-skeleton-text animated style="width: 40%; height: 16px; margin-top: 8px;"></ion-skeleton-text>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-header>
    </ion-card>
  </div>

  <!-- Liste des utilisateurs -->
  <div *ngIf="!isLoading()">
    
    <!-- Message si aucun résultat -->
    <div *ngIf="filteredUsers.length === 0" class="empty-state">
      <ion-icon name="person-circle-outline" class="empty-icon"></ion-icon> <!-- CORRIGÉ -->
      <h3>Aucun utilisateur trouvé</h3>
      <p>Ajustez vos critères de recherche ou de filtrage</p>
      
      <!-- Bouton Ajouter Utilisateur dans l'état vide -->
      <ion-button (click)="navigateToAddUser()" fill="outline" class="empty-state-button">
        <ion-icon name="person-add-outline" slot="start"></ion-icon> <!-- CORRIGÉ -->
        Ajouter un Utilisateur
      </ion-button>
    </div>

    <!-- Liste des utilisateurs -->
    <ion-list *ngIf="filteredUsers.length > 0" class="users-list">
      <ion-item-divider color="light" class="list-divider">
        <ion-label>Utilisateurs ({{ filteredUsers.length }})</ion-label>
        
        <!-- Bouton Ajouter Utilisateur dans le header de liste -->
        <ion-button 
          slot="end" 
          (click)="navigateToAddUser()" 
          fill="outline" 
          size="small"
          class="add-user-list-button"
        >
          <ion-icon name="person-add-outline" slot="start"></ion-icon> <!-- CORRIGÉ -->
          Ajouter
        </ion-button>
      </ion-item-divider>

      <ion-card 
        *ngFor="let user of filteredUsers" 
        class="user-card" 
        (click)="openUserDetails(user)"
      >
        <ion-card-header>
          <ion-grid>
            <ion-row class="ion-align-items-center">
              
              <!-- Photo de profil -->
              <ion-col size="auto">
                <ion-avatar class="user-avatar">
                  <img [src]="getUserPhoto(user)" [alt]="user.firstName" />
                </ion-avatar>
              </ion-col>

              <!-- Informations principales -->
              <ion-col>
                <div class="user-main-info">
                  <h3 class="user-name">{{ user.firstName }} {{ user.lastName }}</h3>
                  <p class="user-email">{{ user.email }}</p>
                </div>
                
                <div class="user-meta">
                  <ion-chip [color]="getRoleColor(user.role)" class="role-chip">
                    {{ getRoleText(user.role) }}
                  </ion-chip>
                  
                  <ion-chip 
                    *ngIf="user.membershipStatus" 
                    [color]="getMembershipStatusColor(user.membershipStatus)"
                    class="status-chip"
                  >
                    {{ getMembershipStatusText(user.membershipStatus) }}
                  </ion-chip>
                </div>
              </ion-col>

              <!-- Actions (Edit, Delete, Badge) -->
              <ion-col size="auto">
                <div class="user-actions">
                  <!-- Badge type d'abonnement -->
                  <ion-badge *ngIf="user.membershipType" color="tertiary" class="membership-badge">
                    {{ user.membershipType }}
                  </ion-badge>
                  
                  <!-- Boutons d'action -->
                  <div class="action-buttons">
                    <!-- Bouton Éditer -->
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      class="action-button edit-button"
                      (click)="editUser(user, $event)"
                    >
                      <ion-icon name="create-outline" slot="icon-only"></ion-icon> <!-- CORRIGÉ -->
                    </ion-button>
                    
                    <!-- Bouton Supprimer -->
                    <ion-button 
                      fill="clear" 
                      size="small" 
                      class="action-button delete-button"
                      (click)="deleteUser(user, $event)"
                    >
                      <ion-icon name="trash-outline" slot="icon-only"></ion-icon> <!-- CORRIGÉ -->
                    </ion-button>
                  </div>
                </div>
              </ion-col>

            </ion-row>
          </ion-grid>
        </ion-card-header>
      </ion-card>
    </ion-list>
  </div>

</ion-content>

<!-- Modal de détails utilisateur -->
<ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="user-details-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="dark">
        <ion-buttons slot="start">
          <ion-button (click)="closeModal()">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon> <!-- CORRIGÉ -->
          </ion-button>
        </ion-buttons>
        <ion-title>Détails Utilisateur</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding" color="light" *ngIf="selectedUser">
      
      <!-- En-tête du profil -->
      <div class="profile-header">
        <ion-avatar class="profile-avatar">
          <img [src]="getUserPhoto(selectedUser)" [alt]="selectedUser.firstName" />
        </ion-avatar>
        
        <div class="profile-info">
          <h2 class="profile-name">{{ selectedUser.firstName }} {{ selectedUser.lastName }}</h2>
          <p class="profile-role">
            <ion-chip [color]="getRoleColor(selectedUser.role)" class="role-chip-large">
              {{ getRoleText(selectedUser.role) }}
            </ion-chip>
          </p>
        </div>
      </div>

      <!-- Informations de contact -->
      <ion-card class="info-card">
        <ion-card-header>
          <ion-card-title class="card-title">
            <ion-icon name="person-circle-outline" class="card-icon"></ion-icon> <!-- CORRIGÉ -->
            Informations Personnelles
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-grid class="info-grid">
            <ion-row>
              <ion-col size="12">
                <div class="info-item">
                  <ion-icon name="mail-outline" class="info-icon"></ion-icon> <!-- CORRIGÉ -->
                  <div class="info-content">
                    <span class="info-label">Email</span>
                    <span class="info-value">{{ selectedUser.email }}</span>
                  </div>
                </div>
              </ion-col>
              
              <ion-col size="12">
                <div class="info-item">
                  <ion-icon name="call-outline" class="info-icon"></ion-icon> <!-- CORRIGÉ -->
                  <div class="info-content">
                    <span class="info-label">Téléphone</span>
                    <span class="info-value">{{ selectedUser.phone }}</span>
                  </div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Informations d'abonnement -->
      <ion-card class="info-card" *ngIf="selectedUser.membershipType">
        <ion-card-header>
          <ion-card-title class="card-title">
            <ion-icon name="trophy-outline" class="card-icon"></ion-icon> <!-- CORRIGÉ -->
            Abonnement
          </ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-grid class="info-grid">
            <ion-row>
              <ion-col size="12" size-sm="6">
                <div class="info-item">
                  <ion-icon name="person-circle-outline" class="info-icon"></ion-icon> <!-- CORRIGÉ -->
                  <div class="info-content">
                    <span class="info-label">Type d'abonnement</span>
                    <span class="info-value">{{ selectedUser.membershipType || 'Non défini' }}</span>
                  </div>
                </div>
              </ion-col>
              
              <ion-col size="12" size-sm="6">
                <div class="info-item">
                  <ion-badge [color]="getMembershipStatusColor(selectedUser.membershipStatus)" class="status-badge-large">
                    {{ getMembershipStatusText(selectedUser.membershipStatus) }}
                  </ion-badge>
                </div>
              </ion-col>
              
              <ion-col size="12" size-sm="6">
                <div class="info-item">
                  <ion-icon name="calendar-outline" class="info-icon"></ion-icon> <!-- CORRIGÉ -->
                  <div class="info-content">
                    <span class="info-label">Date de début</span>
                    <span class="info-value">{{ formatDate(selectedUser.startDate) }}</span>
                  </div>
                </div>
              </ion-col>
              
              <ion-col size="12" size-sm="6">
                <div class="info-item">
                  <ion-icon name="time-outline" class="info-icon"></ion-icon> <!-- CORRIGÉ -->
                  <div class="info-content">
                    <span class="info-label">Date de fin</span>
                    <span class="info-value">{{ formatDate(selectedUser.endDate) }}</span>
                  </div>
                </div>
              </ion-col>
              
              <ion-col size="12">
                <div class="info-item">
                  <ion-icon name="trophy-outline" class="info-icon"></ion-icon> <!-- CORRIGÉ -->
                  <div class="info-content">
                    <span class="info-label">Jours restants</span>
                    <span class="info-value highlight">{{ getDaysRemaining(selectedUser.endDate) }}</span>
                  </div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Message si pas d'abonnement -->
      <ion-card class="info-card" *ngIf="!selectedUser.membershipType">
        <ion-card-content class="no-membership">
          <ion-icon name="trophy-outline" class="no-membership-icon"></ion-icon> <!-- CORRIGÉ -->
          <h3>Aucun abonnement actif</h3>
          <p>Cet utilisateur n'a pas d'abonnement en cours</p>
        </ion-card-content>
      </ion-card>

    </ion-content>
  </ng-template>
</ion-modal>